<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>- StanJapap</title>
    <link rel="stylesheet" href="styles/messages.css">
</head>
<body id="left">
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>Discussions</h2>
            <div class="sidebar-buttons">
                <button>‚ûï</button>
                <button>üë§</button>
            </div>
        </div>
        <input type="text" class="search-bar" placeholder="Rechercher...">
        <div class="contacts">
            <div class="contact active"><span><img src="https://via.placeholder.com/40" alt=""> Contact 1</span></div>
            <div class="contact"><span><img src="https://via.placeholder.com/40" alt=""> Contact 2</span></div>
            <div class="contact"><span><img src="https://via.placeholder.com/40" alt=""> Contact 3</span></div>
        </div>
    </div>
    <div class="chat-container">
        <div class="chat-header">
            <div class="contact" id="opened"><button id="back">‚ùé</button><img src="https://via.placeholder.com/40" alt=""> Contact 1</div>
        </div>
        <div class="messages">
            <hr>
            <p>13/02/2025</p>
            <div class="message received">Bonjour !</div>
            <div class="message received">Je suis inscrit.</div>
            <div class="message sent">Salut, comment √ßa va ?</div>
            <hr>
            <p>Lundi</p>
            <div class="message sent">Salut</div>
            <div class="message sent">Comment √ßa va ?</div>
            <div class="message received">Bonjour !</div>
        </div>
        <div class="chat-input">
            <input type="text" placeholder="√âcrire un message...">
            <button>&#10148;</button>
        </div>
    </div>
    <script type="module">
        import { getFirestore, collection, query, where, getDocs, updateDoc, orderBy, onSnapshot, Timestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        const db = getFirestore();

        const request = await fetch("https://getfriends-b2lv2k7uwq-uc.a.run.app", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ "email": JSON.parse(localStorage.getItem("user")).email })
        });
        const response = await request.json();

        if (request.status === 200){
            localStorage.setItem("conversations", JSON.stringify(response.conversations));
            localStorage.setItem("friends", JSON.stringify(response.friends));
            renderContactList();
            listenForNewMessages(JSON.parse(localStorage.getItem("user")).email);
        }


        async function markMessagesAsRead(contact) {
            const messagesRef = collection(db, "messages");
            const q = query(
                messagesRef,
                where("receiverMail", "==", userEmail),
                where("senderMail", "==", contact),
                where("read", "==", false)
            );

            try {
                const snapshot = await getDocs(q);
                snapshot.forEach(async (doc) => {
                    await updateDoc(doc.ref, { read: true });
                });

                let conversations = JSON.parse(localStorage.getItem("conversations")) ?? {};
                conversations[contact]?.unreadCount = 0;
                localStorage.setItem("conversations", JSON.stringify(conversations));
                renderContactList();
            } catch (error) {
                console.error("Erreur lors de la mise √† jour des messages :", error);
            }
        }

        function renderContactList() {
            let contactList = document.querySelector(".contacts");
            contactList.innerHTML = ""; // R√©initialiser

            let conversations = JSON.parse(localStorage.getItem("conversations")) ?? {};

            for (let contact in Object.entries(conversations).sort((a, b) => b[1].lastMessage - a[1].lastMessage).reduce((acc, [key, value]) => ({ ...acc, [key]: value }), {})) {
                const c = document.createElement("div");
                if (conversations[contact].unreadCount > 0)
                    c.style.setProperty("--unread", `"${conversations[contact].unreadCount}"`);
                c.classList.add("contact");

                const contactData = JSON.parse(localStorage.getItem("friends"))[contact];
                c.innerHTML = `<span><img src="${contactData.ppUrl}" alt="${contactData.pseudo}"> ${JSON.parse(localStorage.getItem("user"))["aliases"][contact] ?? contactData.pseudo}</span>`;
                contactList.appendChild(c);
            }
        }

        function listenForNewMessages(email) {
            const messagesRef = collection(db, "messages");
            const q = query(messagesRef, where("receiverMail", "==", email));

            onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        let newMessage = change.doc.data();
                        let sender = newMessage.senderMail;

                        let conversations = JSON.parse(localStorage.getItem("conversations")) ?? {};
                        
                        if (!conversations[sender]) {
                            conversations[sender] = { messages: [], lastMessage: newMessage.timestamp, unreadCount: 0 };
                        }
                        conversations[sender].messages.push(newMessage);
                        conversations[sender].lastMessage = newMessage.timestamp;
                        conversations[sender].unreadCount++;
                        
                        localStorage.setItem("conversations", JSON.stringify(conversations));
                        renderContactList();

                        // Si la conversation est actuellement ouverte, afficher imm√©diatement le message
                        if (document.querySelector(".chat-container").getAttribute("data-active") === sender) {
                            openChat(sender);
                        }
                    }
                });
            });
        }

        function openChat(contact) {
            const contactData = JSON.parse(localStorage.getItem("friends"))[contact];

            const header = document.querySelector("#opened");
            header.innerHTML = `<button id="back">‚ùé</button><img src="${contactData.ppUrl}" alt="${contactData.pseudo}"> ${JSON.parse(localStorage.getItem("user"))["aliases"][contact] ?? contactData.pseudo}`;

            document.querySelector("#back").addEventListener("click", ()=>{
                document.querySelector(".chat-container").setAttribute("data-active", "");
                body.id = "left";
            })

            const messagesZone = document.querySelector(".messages");
            messagesZone.innerHTML = ""; // R√©initialiser

            let conversations = JSON.parse(localStorage.getItem("conversations")) ?? {};
            let messages = conversations[contact]?.messages.sort((a, b) => a.timestamp - b.timestamp);
            let date = null;

            messages.forEach(msg => {
                // Date
                let msgDate = msg.timestamp.toDate();
                msgHour = msgDate.toLocaleTimeString("fr-FR").slice(0, 5);
                msgDate = msgDate.toLocaleDateString("fr-FR"); // "13/02/2025"

                if (msgDate !== date){
                    messagesZone.innerHTML += `<hr><p>${msgDate}</p>`
                }
                const messageElement = document.createElement("div");
                messageElement.classList.add("message", msg.receiverMail === contact ? "sent" : "received");
                messageElement.style.setProperty("--time", `"${msgHour}"`);
                document.querySelector(".chat-container").setAttribute("data-active", contact);
                messagesZone.appendChild(messageElement);
            });

            // Marquer les messages comme lus
            markMessagesAsRead(contact);
        }
    </script>
</body>
</html>