<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StanJapap</title>
    <link rel="stylesheet" href="styles/messages.css">
</head>
<body id="left">
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>Discussions</h2>
            <div class="sidebar-buttons">
                <!-- <button>‚ûï</button> -->
                <button id="myProfile">üë§</button>
            </div>
        </div>
        <input type="text" id="search-bar" placeholder="Rechercher...">
        <div class="contacts">
        </div>
    </div>
    <div class="chat-container" tag-message="none">
        <div class="chat-header">
            <div class="contact" id="opened"><button id="back">‚ùé</button><img src="" alt=""></div>
        </div>
        <div class="messages">
        </div>
        <div class="chat-input">
            <div class="tagMaster">
                <div class="tagzone">
                    <div class="tagdata">
                        <div class="tagsender"></div>
                        <div class="tagmessage"></div>
                    </div>
                    <span id="close-tag">‚ùå</span>
                </div>
            </div>
            <div class="chat-inputs">
                <textarea placeholder="√âcrire un message..." id="textMessage"></textarea>
                <button>&#10148;</button>
            </div>
        </div>
    </div>
    <script type="module">
        let write_to = null;
        if (localStorage.hasOwnProperty("WRITE_TO")){
            write_to = localStorage.getItem("WRITE_TO");
            localStorage.removeItem("WRITE_TO");
        }

        preventBack();
        window.addEventListener("popstate", function (event) {
            preventBack();
        });
        document.addEventListener('contextmenu', function(event) {
            event.preventDefault();
        });
        function preventBack() {
            history.pushState(null, "", window.location.href);
            history.pushState(null, "", window.location.href);
        }

        document.title = getUser().pseudo + " - StanJapap";

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs, updateDoc, orderBy, onSnapshot, Timestamp, startAt } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        
        const firebaseConfig = {
            apiKey: "AIzaSyDwRreHnfABpGF2x6tN4wHe6VZUE_nRun4",
            authDomain: "stanjapap.firebaseapp.com",
            databaseURL: "https://stanjapap-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "stanjapap",
            storageBucket: "stanjapap.firebasestorage.app",
            appId: "1:143091903095:web:bb74bfa8ca7d41120a7472"
        };
            
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                console.log("Utilisateur non connect√©.");
                window.location.href = "/";
            }
        });

        const chatContainer = document.querySelector(".chat-container");
        const messagesZone = document.querySelector(".messages");
        const textMessage = document.querySelector("#textMessage");
        const searchText = document.querySelector("#search-bar");
        const contactList = document.querySelector(".contacts");
        const tagMaster = document.querySelector(".tagMaster");
        const DAYS = [ "Dimanche", "Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi", "Samedi"];

        let contactActive = null;

        if (!write_to){
            const request = await fetch("https://getfriends-b2lv2k7uwq-uc.a.run.app", {
                method: "POST",
                headers: { 
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${getUser().token}`
                },
                body: JSON.stringify({ "email": getUser().email })
            });
            
            if (request.status === 200){
                const response = await request.json();

                for (const user in response.conversations) {
                    response.conversations[user].messages =  response.conversations[user].messages.sort((a, b) => {
                        const timeA = (a.timestamp?.seconds ?? a.timestamp?._seconds) * 1000 + (a.timestamp?.nanoseconds ?? a.timestamp?._nanoseconds) / 1e6;
                        const timeB = (b.timestamp?.seconds ?? b.timestamp?._seconds) * 1000 + (b.timestamp?.nanoseconds ?? b.timestamp?._nanoseconds) / 1e6;
                        return timeA - timeB;
                    });
                    
                    const length = response.conversations[user].messages.length;
                    if (length > 0){
                        const lastMessage = response.conversations[user].messages[length - 1];
                        response.conversations[user].lastMessage = { 
                            "seconds": lastMessage.timestamp.seconds ?? lastMessage.timestamp._seconds,
                            "content": lastMessage.content
                        }
                    }
                }
                localStorage.setItem("conversations", JSON.stringify(response.conversations));
                renderContactList();
                listenForNewMessages(getUser().email);
                listenForReadReceipts(getUser().email);
            }
            else if (request.status === 401){
                console.log("Utilisateur non connect√©.");
                window.location.href = "/";
            }
        }
        else{
            renderContactList();
            listenForNewMessages(getUser().email);
            listenForReadReceipts(getUser().email);
        }

        function getUser(){
            return JSON.parse(localStorage.getItem("user"));
        }

        function isDateInLastDays(date, nbDays) {
            const today = new Date();
            const pastDate = new Date();
            pastDate.setDate(today.getDate() - nbDays);
            
            return date >= pastDate;
        }

        function getFormattedDateLabel(date) {
            const today = new Date();
            const messageDate = new Date(date);
            today.setHours(0, 0, 0, 0);
            messageDate.setHours(0, 0, 0, 0);

            if (messageDate.getTime() === today.getTime())
                return "Aujourd'hui";

            const yesterday = new Date();
            yesterday.setDate(today.getDate() - 1);
            yesterday.setHours(0, 0, 0, 0);

            if (messageDate.getTime() === yesterday.getTime())
                return "Hier";

            if (isDateInLastDays(messageDate, 6))
                return DAYS[messageDate.getDay()];

            return messageDate.toLocaleDateString("fr-FR");
        }

        async function markMessagesAsRead(contact) {
            const messagesRef = collection(db, "messages");
            const q = query(
                messagesRef,
                where("receiverMail", "==", getUser().email),
                where("senderMail", "==", contact),
                where("read", "==", false)
            );

            try {
                const snapshot = await getDocs(q);
                snapshot.forEach(async (doc) => {
                    await updateDoc(doc.ref, { read: true });
                });

                let conversations = JSON.parse(localStorage.getItem("conversations")) ?? {};
                if (conversations[contact])
                    conversations[contact].unreadCount = 0;
                localStorage.setItem("conversations", JSON.stringify(conversations));
            } catch (error) {
                console.error("Erreur lors de la mise √† jour des messages :", error);
            }
        }

        function renderContactList(conversations = null) {
            contactList.innerHTML = ""; // R√©initialiser

            if (!conversations)
                conversations = JSON.parse(localStorage.getItem("conversations")) ?? {};

            conversations = Object.entries(conversations)
            .sort(([, a], [, b]) => (b.lastMessage?._seconds ?? b.lastMessage?.seconds) - (a.lastMessage?._seconds ?? a.lastMessage?.seconds))
            .reduce((acc, [key, value]) => {
                acc[key] = value;
                return acc;
            }, {});

            for (let contact in conversations) {
                const c = document.createElement("div");
                if (conversations[contact].unreadCount > 0)
                    c.style.setProperty("--unread", `"${conversations[contact].unreadCount}"`);
                c.classList.add("contact");
                
                c.innerHTML = `
                    <span>
                        <img src="${conversations[contact].ppUrl}" alt="${conversations[contact].pseudo}">
                        <div class="preview">
                            <span class="nom">${getUser()["aliases"] ? getUser()["aliases"][contact] ?? conversations[contact].pseudo : conversations[contact].pseudo }</span>
                            <div class="desc">${conversations[contact]["lastMessage"]["content"] ?? ""}</div>
                        </div>
                    </span>
                `;
                c.addEventListener("click", () => {
                    if (contactActive)
                        contactActive.classList.remove("active");
                    c.classList.add("active");
                    c.style.setProperty("--unread", 0);
                    contactActive = c;
                    document.body.id = "right";
                    openChat(contact);
                    textMessage.focus();
                    textMessage.value = "";
                    messagesZone.scrollTop = messagesZone.scrollHeight;
                });
                contactList.appendChild(c);

                if (write_to && atob(write_to) === contact){
                    c.click();
                    write_to = null;
                }
            }
        }

        function listenForNewMessages(email) {
            const messagesRef = collection(db, "messages");
            const q = query(
                messagesRef,
                where("receiverMail", "==", email),
                where("senderMail", "not-in", [email]),
                orderBy("timestamp"),
                startAt(Timestamp.now())
            );

            onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        console.log("Nouveau message re√ßu !");
                        let newMessage = change.doc.data();
                        let sender = newMessage.senderMail;

                        let conversations = JSON.parse(localStorage.getItem("conversations")) ?? {};

                        if (!conversations[sender]) {
                            conversations[sender] = { messages: [], lastMessage: null, unreadCount: 0 };
                        }
                        conversations[sender].messages.push(newMessage);
                        conversations[sender].lastMessage = { "seconds": newMessage.timestamp.seconds ?? newMessage.timestamp._seconds, "content": newMessage.content };    
                        conversations[sender].unreadCount++;

                        localStorage.setItem("conversations", JSON.stringify(conversations));
                        renderContactList();

                        if (chatContainer.getAttribute("data-active") === sender) {
                            openChat(sender);
                        }
                    }
                });
            });
        }

        function listenForReadReceipts(email) {
            const messagesRef = collection(db, "messages");
            const q = query(messagesRef, where("senderMail", "==", email)); // √âcoute les messages que l'utilisateur a envoy√©s

            onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "modified") {
                        let updatedMessage = change.doc.data();
                        let receiver = updatedMessage.receiverMail;

                        // V√©rifie si le message a √©t√© lu
                        if (updatedMessage.read) {
                            let conversations = JSON.parse(localStorage.getItem("conversations")) ?? {};

                            if (conversations[receiver]) {
                                let messageIndex = conversations[receiver].messages.findIndex(m => {
                                    if (m.timestamp.hasOwnProperty("_seconds"))
                                        return m.timestamp._seconds === updatedMessage.timestamp.seconds
                                    else
                                        return m.timestamp.seconds === updatedMessage.timestamp.seconds
                                });

                                if (messageIndex !== -1)
                                    conversations[receiver].messages[messageIndex].read = true;

                                localStorage.setItem("conversations", JSON.stringify(conversations));                                
                                // Met √† jour le chat ouvert
                                if (chatContainer.getAttribute("data-active") === receiver) {
                                    openChat(receiver);
                                }
                            }
                        }
                    }
                });
            });
        }

        function openChat(contact) {
            let conversations = JSON.parse(localStorage.getItem("conversations")) ?? {};
            const header = document.querySelector("#opened");
            header.innerHTML = `<button id="back">‚ùé</button><img src="${conversations[contact].ppUrl}" alt="${conversations[contact].pseudo}"> ${getUser()["aliases"] ? getUser()["aliases"][contact] ?? conversations[contact].pseudo : conversations[contact].pseudo }`;

            document.querySelector("#back").addEventListener("click", ()=>{
                chatContainer.setAttribute("data-active", "");
                renderContactList();
                document.body.id = "left";
            })

            messagesZone.innerHTML = ""; // R√©initialiser
            let messages = conversations[contact]?.messages ?? [];
            let date = null;

            messages.forEach(msg => {
                // Date
                let time = msg.timestamp.seconds ?? msg.timestamp._seconds;
                let msgDate = new Date(time * 1000);
                let msgHour = msgDate.toLocaleTimeString("fr-FR").slice(0, 5);
                let messageDate = msgDate.toLocaleDateString("fr-FR");

                if (messageDate !== date){
                    messagesZone.innerHTML += `<br><hr><p>${getFormattedDateLabel(msgDate)}</p>`
                    date = messageDate;
                }
                const messageElement = document.createElement("div");
                messageElement.id = `m-id-${messages.indexOf(msg)}`;
                messageElement.classList.add("message", msg.receiverMail === contact ? msg.read ? "seen" : "sent" : "received");
                messageElement.style.setProperty("--time", `"${msgHour}"`);
                messageElement.innerHTML = msg.content;
                messagesZone.appendChild(messageElement);

                // Pour les tags
                messageElement.addEventListener("click", (e) => showOptions(messageElement, msg.receiverMail === contact));                
            });
            
            chatContainer.setAttribute("data-active", contact);
            // Marquer les messages comme lus
            markMessagesAsRead(contact);
        }
        
        function showOptions(message, isSender) {
            const id = message.id.split("m-id-")[1];

            const options = document.createElement("div");
            options.classList.add("message-options");

            const tagButton = document.createElement("button");
            tagButton.textContent = "üîÑ R√©pondre";
            tagButton.addEventListener("click", () => tagMessage(id));
            options.appendChild(tagButton);

            const delButton = document.createElement("button");
            delButton.textContent = "üöÆ Supprimer";
            delButton.addEventListener("click", () => tagMessage(id));
            options.appendChild(delButton);

            setTimeout(() => {
                document.addEventListener("click", () => options.remove(), { once: true });
            }, 20);

            document.body.appendChild(options);
            
            const messageRect = message.getBoundingClientRect();
            const optionsRect = options.getBoundingClientRect();
            options.style.top = `${messageRect.top + window.scrollY}px`;
            if (isSender)
                options.style.left = `${messageRect.left - optionsRect.width - 10}px`;
            else
                options.style.left = `${messageRect.left + messageRect.width + 10}px`;
        }

        function tagMessage(messageId) {
            if (!messageId) {
                console.log("id absent");
                return;
            }

            const receiverMail = chatContainer.getAttribute("data-active");
            
            if (receiverMail === "") {
                console.log("mail absent");
                return;
            }

            let conversations = JSON.parse(localStorage.getItem("conversations"));
            const messageList = conversations[receiverMail]?.messages;

            if (+messageId >= messageList.length) {
                console.log("MessageId est trop grand");
                return;
            }

            const message = messageList[+messageId];
            chatContainer.setAttribute("tag-message", messageId);

            tagMaster.style.display = "flex";
            if (message.receiverMail === receiverMail)
                document.querySelector(".tagsender").textContent = "Vous";
            else
                document.querySelector(".tagsender").textContent = getUser()["aliases"] ? getUser()["aliases"][receiverMail] ?? conversations[receiverMail].pseudo : conversations[receiverMail].pseudo;
            document.querySelector(".tagmessage").textContent = message.content;
        }

        let sendingMessage = false;
        async function sendMessage(){
            if (sendingMessage) return;
            sendingMessage = true;

            const receiverMail = chatContainer.getAttribute("data-active");
            const messageToSend = textMessage.value.trim();
            if (!receiverMail || receiverMail === "" || !messageToSend || messageToSend === ""){
                sendingMessage = false;
                return;
            }

            const request = await fetch("https://sendmessage-b2lv2k7uwq-uc.a.run.app", {
                "method": "POST",
                "headers": {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${getUser().token}`
                },
                "body": JSON.stringify({ "senderMail": getUser().email, "receiverMail": receiverMail, "content": messageToSend })
            });
            if (request.status === 200){
                const message = (await request.json()).message;

                let conversations = JSON.parse(localStorage.getItem("conversations")) ?? {};                        
                if (!conversations[receiverMail]) {
                    conversations[receiverMail] = { messages: [], lastMessage: null, unreadCount: 0 };
                }
                conversations[receiverMail].messages.push(message);
                conversations[receiverMail].lastMessage = { "seconds": message.timestamp.seconds ?? message.timestamp._seconds, "content": message.content };    
                
                localStorage.setItem("conversations", JSON.stringify(conversations));
                renderContactList();
                openChat(receiverMail);
                textMessage.value = "";
            }
            else if (request.status === 401){
                console.log("Utilisateur non connect√©.");
                window.location.href = "/";
            }

            textMessage.focus();
            messagesZone.scrollTop = messagesZone.scrollHeight;
            sendingMessage = false;
        }
        document.querySelector(".chat-input button").addEventListener("click", sendMessage);
        textMessage.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                if (event.shiftKey) {
                    const cursorPosition = textMessage.selectionStart;
                    textMessage.value = textMessage.value.substring(0, cursorPosition) + '\n' + textMessage.value.substring(cursorPosition);
                    textMessage.selectionStart = textMessage.selectionEnd = cursorPosition + 1;
                } else
                    sendMessage();
            }
        });
    
        function filterConversations() {
            const text = searchText.value.trim().toLowerCase();

            if (!text || text === ""){
                renderContactList();
                return;
            }

            const conversations = JSON.parse(localStorage.getItem("conversations")) ?? {};
            const aliases = getUser().aliases;

            const filteredConversations = Object.fromEntries(Object.entries(conversations).filter(([email, conv]) => {
                const pseudo = conv.pseudo.toLowerCase() ?? "";
                const alias = aliases[email]?.toLowerCase() ?? "";

                return pseudo.includes(text) || alias.includes(text);
            }));
            renderContactList(filteredConversations);
        }
        searchText.addEventListener("input", filterConversations);
        
        document.querySelector("#myProfile").addEventListener("click", () => location.href = "profil.html");
        
        document.querySelector("#close-tag").addEventListener("click", () => {
            const receiverMail = chatContainer.getAttribute("tag-message");
            if (receiverMail === "") return;
            chatContainer.setAttribute("tag-message", "none");
            tagMaster.style.display = "none";
        });
    </script>
</body>
</html>