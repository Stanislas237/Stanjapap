<!DOCTYPE html>
<html lang="fr">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Authentification - Stanjapap</title>
        <link rel="icon" sizes="321x312" href="img/icon.png" type="image/png" />
        <link rel="stylesheet" href="styles/index.css">
    </head>
    <body>
        <div class="container">
            <div class="tab">
                <button id="login-tab" class="active tab-button" onclick="switchTab('login')">Connexion</button>
                <button id="register-tab" class="tab-button" onclick="switchTab('register')">Inscription</button>
            </div>
            
            <form class="active login">
                <input type="email" placeholder="Email" required>
                <input type="password" placeholder="Mot de passe" required>
                <button type="submit" id="login">Se connecter</button>
                <div class="spinner">
                    <div id="spinner"></div>
                </div>    
            </form>
            
            <form class="register">
                <input type="text" placeholder="Nom et Prénom" id="name" required>
                <input type="text" placeholder="Pseudo" id="pseudo" required>
                <input type="email" placeholder="Email" required>
                <input type="password" placeholder="Mot de passe" required>
                <input type="password" placeholder="Confirmer le mot de passe" required>
                <button type="submit" id="register">S'inscrire</button>
                <div class="spinner">
                    <div id="spinner"></div>
                </div>    
            </form>
        </div>

        <script>
            function switchTab(tab) {
                document.querySelectorAll('form').forEach(f => f.classList.remove('active'));
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));                
                document.querySelector(`.${tab}`).classList.add('active');
                document.querySelector(`#${tab}-tab`).classList.add('active');
            }

            if (localStorage.hasOwnProperty("user"))
                location.href = "messages.html";
        </script>
        <script type="module">
            import { signIn, signUp, setOneDoc, getOneDoc, now, generateToken } from "/js/App.js";
    
            const register = document.querySelector("form.register");
            const login = document.querySelector("form.login");
    
            function showSpinner() {
                document.querySelectorAll(".spinner").forEach(spinner => spinner.style.display = "flex");
                document.querySelectorAll("button[type='submit']").forEach(b => b.style.display = "none");
            }
            
            function hideSpinner() {
                document.querySelectorAll(".spinner").forEach(spinner => spinner.style.display = "none");
                document.querySelectorAll("button[type='submit']").forEach(b => b.style.display = "block");
            }
    
            register.addEventListener("submit", (e) => {
                e.preventDefault();    
                showSpinner();
    
                const email = form.querySelector("input[type='email']").value;
                const passwords = form.querySelectorAll("input[type='password']");
                const name = form.querySelector("#name").value.trim();
                const pseudo = form.querySelector("#pseudo").value;

                if (passwords[0].value !== passwords[1].value) {
                    alert("Les mots de passe ne correspondent pas !");
                    hideSpinner();
                    return;
                }

                signUp(email, passwords[0].value).then(result => {
                    switch (result) {
                        case 1:
                            setOneDoc("users", email, { actu: "Disponible", aliases: {}, registerDate: now(), "name": name, "pseudo": pseudo, "password": passwords[0], ppUrl: "https://as2.ftcdn.net/v2/jpg/01/99/45/45/1000_F_199454533_GIBKQvbUBlu0hl5xhn64pJOHp1nn5W2C.jpg" })
                            .then(() => alert("Veuillez cliquer sur le lien envoyé à votre e-mail"))
                            .catch(() => alert("Une erreur est survenue. Veuillez contacter le support"));
                            break;
                        case 2:
                            alert("Nous n'avons pas pu vous envoyer d'email de vérification. Veuillez contacter le support.")
                            break;                    
                        default:
                            alert("Une erreur est survenue. Veuillez réessayer");
                            break;
                    }
                }).catch(() => alert("Une erreur est survenue. Veuillez réessayer"));
                hideSpinner();
            });

            login.addEventListener("submit", (e) => {
                e.preventDefault();
                showSpinner();

                const email = form.querySelector("input[type='email']").value;
                const password = form.querySelector("input[type='password']").value;
            
                signIn(email, password).then(isUserSignedIn => {
                    if (!isUserSignedIn)
                        alert("En attente de vérification...");
                    else{
                        setOneDoc("users", email, { token: generateToken() })
                        .then(() => getOneDoc("users", email)
                            .then(doc => {
                                if (doc) {
                                    localStorage.setItem("user", JSON.stringify(doc));
                                    location.href = "messages.html";
                                }
                                else
                                    alert("Impossible de récupérer vos informations. Veuillez réessayer");
                            })
                            .catch(() => alert("Impossible de récupérer vos informations. Veuillez réessayer")))
                        .catch(() => alert("Impossible de mettre à jour vos informations. Veuillez réessayer"));
                    }
                    hideSpinner();
                })
                .catch(() => {
                    hideSpinner();
                    alert("Échec de la connexion");
                });
            });
        </script>    
    </body>
</html>
